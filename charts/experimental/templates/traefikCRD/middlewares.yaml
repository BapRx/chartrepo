{{ if (include "authelia.ingressTraefik" .) -}}
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: {{ printf "forwardauth-%s" (include "authelia.name" .) }}
  labels:
{{- include "authelia.labels" . | nindent 4 }}
{{- with (include "authelia.annotations" .) }}
  annotations:
{{- . | nindent 4 }}
{{- end }}
spec:
  forwardAuth:
    address: {{ printf "http://%s/api/verify?rd=https://%s#/" (include "authelia.name" .) (include "authelia.ingressHostWithPath" .) }}
    trustForwardHeader: true
{{- with .Values.ingress.traefikCRD.authResponseHeaders }}
    authResponseHeaders:
{{- toYaml . | nindent 4 }}
{{- end }}
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: {{ printf "headers-%s" (include "authelia.name" .) }}
  labels:
{{- include "authelia.labels" . | nindent 4 }}
{{- with  (include "authelia.annotations" .) }}
  annotations:
{{- . | nindent 4 }}
{{- end }}
spec:
  headers:
    browserXssFilter: true
    contentTypeNosniff: true
    customFrameOptionsValue: "SAMEORIGIN"
    customResponseHeaders:
      Cache-Control: "no-store"
      Pragma: "no-cache"
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: {{ default (printf "%s-auth" (include "authelia.name" .)) .Values.ingress.traefikCRD.authMiddlewareNameOverride }}
  labels:
{{- include "authelia.labels" . | nindent 4 }}
{{- with  (include "authelia.annotations" .) }}
  annotations:
{{- . | nindent 4 }}
{{- end }}
spec:
  chain:
    middlewares:
{{- with .Values.ingress.traefikCRD.extraMiddlewares.middleware.before }}
{{- toYaml . | nindent 4 }}
{{- end }}
    - name: {{ printf "forwardauth-%s" (include "authelia.name" .) }}
      namespace: {{ .Release.Namespace }}
{{- with .Values.ingress.traefikCRD.extraMiddlewares.middleware.after }}
{{- toYaml . | nindent 4 }}
{{- end }}
---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: {{ include "authelia.name" . }}
  labels:
{{- include "authelia.labels" . | nindent 4 }}
{{- with (include "authelia.annotations" .) }}
  annotations:
{{- . | nindent 4 }}
{{- end }}
spec:
  chain:
    middlewares:
{{- with .Values.ingress.traefikCRD.extraMiddlewares.ingress.before }}
{{- toYaml . | nindent 4 }}
{{- end }}
    - name: {{ printf "headers-%s" (include "authelia.name" .) }}
      namespace: {{ .Release.Namespace }}
{{- with .Values.ingress.traefikCRD.extraMiddlewares.ingress.after }}
{{- toYaml . | nindent 4 }}
{{- end }}
{{- end -}}